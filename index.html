<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>發一崇德台中道場資訊網</title>

<!-- Viewport and fullscreen settings for PWA -->
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
<meta name="theme-color" content="#7e57c2">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">

<style>
/* Base Styles */
html, body{
  margin:0; padding:0;
  width:100%; height:100%;
  display:flex; justify-content:center; align-items:center;
  font-family:'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg,#d1c4e9,#b39ddb,#9575cd,#7e57c2);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  overflow:hidden;
}

/* Glass Container for main content */
.glass-container{
  backdrop-filter: blur(15px);
  background: rgba(255,255,255,0.1);
  border-radius: 25px;
  border: 1px solid rgba(255,255,255,0.2);
  padding: 2em;
  display:flex; flex-direction:column; align-items:center;
  text-align:center;
  color:white;
  max-width:350px; width:90%;
  box-shadow: 0 0 40px rgba(0,0,0,0.3);
}

/* Spinner Styles */
.spinner{
  width:50px; height:50px;
  border:6px solid rgba(255,255,255,0.3);
  border-top:6px solid #b39ddb;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:1em;
}

/* Custom Message Box Styles (replaces alert) */
.message-box {
    display: none; /* Hidden by default */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
    border-radius: 25px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    padding: 2em;
    z-index: 1000;
    text-align: center;
    width: 80%;
    max-width: 300px;
    color: white;
}

.message-box-content {
    margin-bottom: 1em;
}

/* Other Animations and styles */
@keyframes gradientBG{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
@keyframes spin{to{transform:rotate(360deg)}}

#message{font-size:1.2em; margin-bottom:1.5em;}

.action-button{
  background: rgba(255,255,255,0.2);
  color:white;
  border:1px solid rgba(255,255,255,0.4);
  padding:12px 25px;
  border-radius:15px;
  font-size:1em;
  cursor:pointer;
  margin:0.5em 0;
  backdrop-filter: blur(5px);
  transition: all 0.3s ease;
  width:80%;
}
.action-button:hover{
  background: rgba(179,157,219,0.3);
  border-color: rgba(255,255,255,0.6);
  transform: scale(1.05);
}
</style>
</head>
<body>
<div class="glass-container">
  <div id="message">載入中...</div>
  <div class="spinner"></div>
</div>

<!-- Custom message box for better user experience -->
<div class="message-box" id="message-box">
    <div class="message-box-content" id="message-content"></div>
    <button class="action-button" onclick="closeMessageBox()">確認</button>
</div>

<script>
const SITE_URL = 'https://taichung-faith.org';
const container = document.querySelector('.glass-container');
const messageBox = document.getElementById('message-box');
const messageContent = document.getElementById('message-content');

// Function to show a custom message box
function showMessageBox(message) {
    messageContent.innerHTML = message;
    messageBox.style.display = 'block';
}

// Function to close the custom message box
function closeMessageBox() {
    messageBox.style.display = 'none';
}

function detectClient(){
  const ua = navigator.userAgent;
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isAnd = /Android/i.test(ua);
  const isChr = /Chrome\/\d+/i.test(ua)&&!ua.includes('Edg/');
  const isEdg = /Edg\/\d+/i.test(ua);
  const isFx = /Firefox\/\d+/i.test(ua)&&!ua.includes('Seamonkey');
  const isSaf = /Safari\/\d+/i.test(ua)&&!isChr&&!isEdg;
  const inPWA = window.matchMedia('(display-mode: standalone)').matches;
  return {isIOS,isAnd,isChr,isEdg,isFx,isSaf,inPWA};
}

function safeOpen(url){
  try{
    const newWin = window.open(url,'_blank');
    if(!newWin) window.location.href = url;
  }catch(e){window.location.href = url;}
}

window.addEventListener('load',()=>{
  const c = detectClient();
  const msg = document.getElementById('message');
  const spinner = document.querySelector('.spinner');

  let hint='📲 建議安裝至桌面，享受全螢幕體驗。';
  if(c.isIOS && c.isSaf) {
      hint='📲 在 Safari 底部「分享」→『加入主畫面』安裝。';
  } else if(c.isAnd && (c.isChr||c.isEdg)) {
      hint='📲 點網址列右側「安裝圖示」或選單「加入主畫面」。';
  } else if(c.isFx) {
      hint='🦊 Firefox 可用「⋮ 選單→安裝」或手動加入書籤。';
  }

  msg.innerHTML=`👋 歡迎安裝台中道場資訊網<br><br>${hint}<br>將在<strong>20 秒</strong>後自動跳轉網站，<br>或點擊下方按鈕立即前往。`;
  spinner.style.display='none';

  const btn=document.createElement('button');
  btn.className='action-button';
  btn.textContent='立即前往網站';
  btn.onclick = ()=> safeOpen(SITE_URL);
  container.appendChild(btn);

  if(c.isIOS && c.isSaf){
    const iosBtn=document.createElement('button');
    iosBtn.className='action-button';
    iosBtn.textContent='安裝到主畫面';
    // Use the custom message box instead of alert()
    iosBtn.onclick = ()=> showMessageBox('請點選 Safari 底部「分享」→「加入主畫面」即可安裝');
    container.appendChild(iosBtn);
  }

  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e=>{
    e.preventDefault();
    deferredPrompt = e;
    const installBtn=document.createElement('button');
    installBtn.textContent='安裝台中道場資訊網';
    installBtn.className='action-button';
    installBtn.onclick = async()=>{
      try { await deferredPrompt.prompt(); } catch(err){ console.warn('Prompt 被禁止', err); }
      const choice = await deferredPrompt.userChoice;
      console.log(`使用者選擇: ${choice.outcome}`);
      deferredPrompt = null;
    };
    container.appendChild(installBtn);
  });

  setTimeout(()=>{ if(!document.hidden) window.location.href=SITE_URL; },20000);

  // --- Service Worker Registration ---
  // Note: This code enables offline functionality and updates.
  // It may fail in certain environments (e.g., local file:// or sandbox)
  // due to browser security restrictions. For production on a web server,
  // this is the correct way to register a Service Worker.
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
      console.log('Service Worker 註冊成功:', reg.scope);

      // Listen for updates and show a notification
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        if (newSW) {
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              const notice = document.createElement('div');
              notice.id = 'update-notice';
              notice.textContent = '🔄 新版本可用，點擊更新！';
              notice.onclick = () => window.location.reload();
              document.body.appendChild(notice);
            }
          });
        }
      });
    }).catch(err => {
      console.error('Service Worker 註冊失敗:', err);
    });
  }
</script>
</body>
</html>
